\newpage
## Способы активации {#sec:taproot_activation}

\EpisodeQR{3}

Софтфорк Taproot был активирован 13 ноября 2021 года, примерно через год после появления окончательной редакции кода.^[<https://github.com/bitcoin/bitcoin/pull/19953>] Это произошло куда быстрее, чем активация SegWit, и куда менее драматично, но тот год не был совсем уж лишен событий. В этой главе рассказывается, как софтфорки активировались в прошлом, какие способы активации рассматривались для Taproot и как он все-таки был активирован.

Мы посвятили этой теме пять эпизодов, и соответствующие QR-коды размещены в разных частях этой главы. Однако это далеко не однозначное сопоставление; ссылки приведены даже не в хронологическом порядке.

### Софтфорки: введение

По мере приближения развертывания Taproot вопрос о том, как активировать софт-форки, снова стал предметом дискуссий в биткоин-сообществе.

Софтфорки, если вы помните — это обратно совместимые изменения протокола. Другими словами, любой, кто обновился, будет пользоваться преимуществами, которые дает обновление, но те, кто не обновится, все равно останутся с корректно работающим софтом.

Помимо внедрения новых функций, софтфорк можно использовать для избавления от багов и потенциальных уязвимостей — по крайней мере, от некоторых из них. Это делается путем ужесточения правил, но без внезапной заморозки чьих-либо монет.

Простым примером таких более строгих правил является BIP 66,^[<https://en.bitcoin.it/wiki/BIP_0066>], который требует, чтобы любые новые подписи соответствовали строгому стандарту, в то время как ранее существовала некоторая (непреднамеренная) гибкость в способах кодирования подписей.^[<https://technicaldifficulties.io/2020/07/22/bip-66-unpacking-der-signatures/>]

Может показаться парадоксальным, что строгие правила допускают _больше_ возможностей, но в главе @sec:segwit, в разделе про будущие версии SegWit, мы объяснили, почему это так работает. В текущей главе нас меньше интересует, как работают софтфорки, и вместо этого мы сосредоточимся на том, как их активируют.

Есть несколько разных способов внедрить софтфорк. Можно сделать это случайным образом, а можно внедрить его в код намеренно. Также можно объявить дату (день Д) или высоту блока, начиная с которой применяются новые правила. Наконец — и именно так это обычно сейчас работает — можно получать сигналы от майнеров и активировать софтфорк, как только будет достигнут определенный порог.

Но то, как принимается решение о развертывании софтфорка, возможно, даже важнее, чем механика активации. А кто вообще решает?

### Самые ранние софтфорки

Хотя на заре Биткоина этого термина еще не существовало, у него было много софтфорков, в основном связанных с закрытием дыр в безопасности у раннего прототипа.^[<https://blog.bitmex.com/bitcoins-consensus-forks/>] В 2013 году произошел даже случайный софтфорк, а в 2015-м случился случайный софтфорк, который едва не пропал из-за изменений OpenSSL (см. главу @sec:libsecp).

Самые ранние софтфорки в основном использовали в качестве метода активации высоту блока  — другими словами, «начиная с вот этого будущего блока должно применяться новое правило». В идеале об этом объявляют заблаговременно, чтобы у людей было достаточно времени для обновления. В случае «секретного» софтфорка разработчики могли просто настаивать на том, чтобы люди обновлялись, а уже затем объяснять причину.

![Иллюстрация работы софтфорка, активируемого по сигналу на определенной высоте блока](taproot/flag.svg){ width=50% }

<!-- Отрегулируйте ширину вручную, чтобы примерно совпадал размер шрифта -->

Вероятно, самым печально известным софтфорком всех времен остается ограничение размера блока в один мегабайт, введенное Сатоши в 2010 году.^[Начиная с самого первого реелиза версии 0.1.0 от 9 января 2009 г. существовало применяемое к самым разным вещам ограничение в 32 МБ (`MAX_SIZE`). В их число входил размер блока, который проверялся в функции `CheckBlock()`. См. <https://satoshi.nakamotoinstitute.org/code/>. Затем, 15 июля 2010 года, Сатоши ввел параметр MAX_BLOCK_SIZE=1000000 и изменил программное обеспечение для майнеров, чтобы оно не создавало блоки большего размера, чем в <https://github.com/bitcoin/bitcoin/commit/a30b56ebe76ffff9f9cc8a6667186179413c6349>. Это еще не было софтфорком. Это было просто изменение программного обеспечения, используемого майнерами, которое они могли бы отменить, что не привелоо бы к созданию недействительных блоков. Спустя несколько месяцев, 7 сентября, Сатоши модифицировал связанную функцию AcceptBlock(), чтобы принудительно внедрить MAX_BLOCK_SIZE <https://github.com/bitcoin/bitcoin/commit/f1e1fb4bdef878c8fc1564fa418d44e7541a7e83>. Это уже был настоящий софтфорк, и он был выпущен в тот же день в версии 0.3.12. Оба коммита делали вид, что отвечают за совершенно не связанные между собой вещи. В настоящее время рецензенты кода осуждают коммиты, которые касаются чего-либо за пределами области, на изменение которой они претендуют, даже если это просто удаление пустой строки.] Софтфорк был выпущен 7 сентября 2010 года, а параметр `activation_height` для него был установлен на 79 400, и этот блок был добыт всего лишь неделю спустя.^[<https://bitcointalk.org/index.php?topic=999.msg12181>].

Решение Сатоши ввести это ограничение было не только односторонним, но и тайным. Вероятно, он счел более безопасным держать это изменение в секрете, потому что не хотел предупреждать потенциальных злоумышленников о зияющей дыре в безопасности, из-за которой массивные блоки могли остановить работу сети.^[Еще в 2017 году я провел эксперимент, в котором я взял более старые версии Bitcoin Core и измерил, сколько времени им потребовалось, чтобы синхронизировать состояние блокчейна. Современные узлы делали это во много раз быстрее благодаря различным усовершенствованиям, сделанным за прошедшие годы (см., например, главу @sec:assume). Но что еще более важно, Bitcoin Core v0.5, выпущенный в 2012 году, вообще не успевал за блокчейном. При подобной попытке он бы просто упал или ушел в ступор на несколько недель. Без ограничения размера блока, введенного Сатоши, любой в 2012 году мог создать огромные блоки, которые затем перегрузили бы доступное программное обеспечение узла (см. Приложение @sec:more_eps).]

Не то чтобы никто не отслеживал изменения в исходном коде, просто на форуме, где Сатоши анонсировал этот новый релиз, в тот момент обсуждался _еще один_ софтфорк, предлагаемый для активации с блока на той же высоте. В любом случае, никто не обращал на это особого внимания до тех пор, пока много лет спустя этот уменьшенный лимит не приобрел практическую значимость в виде увеличения платы за дефицитное место в блоке.

Но если не считать каких-то экзистенциальных чрезвычайных ситуаций, существует общее мнение, что сейчас это неприемлемый способ введения софтфорка. Если бы уже тогда случились дебаты об ограничении размера блока, возможно, драму, которая разразилась позже, можно было бы предотвратить.

### Как обеспечиваются софтфорки?

Выпуск новой версии программного обеспечения, которая активирует софтфорк на заданной высоте — это одно. Но если его не запустят правильные люди и не сделают это вовремя, на самом деле он не возымеет эффекта. Если софтфорк выпущен в лесу…

Что сделал Сатоши, так это объявил о новой версии на форуме, предполагая, что сообщество достаточно маленькое, и все успеют обновиться до момента активации, даже если до него осталась всего неделя. Как правило, факт обновления не подвергался проверке, потому что многие из этих первоначальных софтфорков были сделаны таким образом, намеренно или случайно, что только злоумышленник мог создавать блоки, нарушающие новое правило, а таких вокруг было немного.

Несмотря на это, даже в 2010 году уже росло понимание того, что самый безопасный способ реализовать софтфорк — это добиться, чтобы подавляющее большинство майнеров запустило последнюю версию. Это связано с тем, что узлы будут наращивать самую длинную цепочку, которую они считают действительной. Таким образом, даже если пользователь не обновил свой узел, пока большинство майнеров соблюдают правила, они будут создавать самую длинную цепочку, и узел пользователя будет следовать за ней. Таким образом, даже если майнер злонамеренно или случайно создаст недопустимый блок, большинство майнеров не будет его надстраивать, и недействительный блок вскоре станет устаревшим. ^ [См. главу @sec:eclipse для объяснения концепции устаревших блоков.]

Мы не знаем, сколько отдельных майнеров было в 2010 году, но вполне возможно, что они были в курсе этих обновлений. ставка до февраля 2010 года:^[Некоторые предполагают, что один майнер под ником Патоши, не обязательно Сатоши, контролировал более 50 процентов хэшрейта до февраля 2010 года: <https://whale-alert.medium.com/the-satoshi-fortune-e49cf73f9a9b>] При этом на майнинге нельзя было сделать деньги: первая продажа пиццы состоялась только в мае того же года.^[<https://bitcoinmagazine.com/culture/the-man-behind-bitcoin-pizza-day-is-more-than-a-meme-hes-a-mining-pioneer>] Даже в 2013г, когда произошел случайный софт-форк, достаточное количество майнеров запустило исправление всего за несколько часов.^[<https://bitcoinmagazine.com/technical/bitcoin-network-shaken-by-blockchain-fork-1363144448>] Но чрезвычайные ситуации — это не то же самое, что обычные софтфорки.

### Кто решает?

Первоначально Сатоши в одностороннем порядке решал, что нужно изменить, хотя в конечном итоге он не мог заставить кого-либо запускать новые версии, которые он выпустил, поэтому он не мог вносить совершенно произвольные спорные изменения.^[Лучше покинуть вечеринку, пока еще получаешь от нее удовольствие, и, возможно, именно так он и поступил: «Но по мере того, как росло недовольство его властью и возможностями, пользователи стали слишком часто осуждать Сатоши-администратора, Сатоши-бутылочное-горлышко, Сатоши-диктатора». <https://bitcoinmagazine.com/technical/what-happened-when-bitcoin-creator-satoshi-nakamoto-disappeared>] В данный момент разработка Биткойна ведется, если не залезать в дебри, в рамках процесса «приблизительного консенсуса», как описано в RFC 7282.^[<https://datatracker.ietf.org/doc/html/rfc7282>]

Любой может предложить изменение правил Биткоина. Но нужно не только убедить других в полезности изменения; также необходимо рассмотреть все технические возражения, которые выдвигаются против него. Например, если кто-то жалуется, что предложение нарушит работу его кошелька, автор предложения не может просто сказать «не повезло». Вместо этого он должен решить проблему. Может быть, он может предложить простое исправление для рассматриваемого кошелька, или изменить свое собственное предложение, чтобы оно ничего не ломало.

Это — наряду с несколькими другими требованиями — обычно означает множество переписок по техническим спискам рассылки, а также множество итераций по улучшению предложения. Многие предложения вообще не выдерживают этот процесс, потому что оказывается, что они вызывают слишком много проблем.

Предложения о хардфорке часто отклоняются только потому, что они ломают существующее программное обеспечение и требуют одновременного обновления от всех участников. То же самое предложение, вводимое как софтфорк, решает обе проблемы, поэтому его обычно предпочитают хард-форку. Вот почему небрежное предложение разработчика Bitcoin Core Люка Даша-младшего о том, что SegWit можно реализовать как софтфорк, изменило правила игры.^[<https://news.ycombinator.com/item?id=11230394>]

Помимо отсутствия неотвеченных возражений, также необходимо привлечь достаточно опытных разработчиков для рассмотрения предложения. Таких разработчиков очень немного, и отсутствие энтузиазма у них может привести к тому, что прекрасный софтфорк никогда не увидит свет. Или, что чаще, отсутствие энтузиазма у рецензента в сочетании с трудноразрешимыми техническими проблемами будет держать предложение в подвешенном состоянии.

Но если все пойдет хорошо и код предложения в конечном итоге будет объединен с кодом Bitcoin Core, остается вопрос, какую процедуру активации применить. Это происходит в рамках такого же процесса приблизительного консенсуса, как и обсуждение самого предложения; людям может понравиться предлагаемый софтфорк, но они, по всем вышеописанным причинам, будут возражать против активации в конкретную дату. Чтобы избежать ситуаций, когда предложения застревают в ходе обсуждения их активации, в идеале сообщество соглашается на единый механизм активации, который применяется для всех софтфорков. Но, конечно, это тоже серьезная проблема для сообщества.

### Сигнализирование (BIP 9)

Итак, если день Д или некая высота блока — не лучший критерий для активации софтфорка, как сделать лучше? Одна из идей заключалась в том, чтобы майнеры сигнализировали о готовности к софтфорку в создаваемых ими блоках. Первоначально это было реализовано путем увеличения номера версии блока.^ [BIP 34 <https://en.bitcoin.it/wiki/BIP_0034> в 2012 году использовал версию 2, а BIP 66 в 2015 году использовал версию 3. Как только 95 процентов последних блоков будут содержать этот новый номер версии, должны начать применяться новые правила.] Сигнализация работает как механизм координации для сети, позволяющий выяснить, достаточно ли майнеров обновило свой софт.

Этот механизм был улучшен и формализован в BIP 9.^[<https://en.bitcoin.it/wiki/BIP_0009>] Как часть механизма сигнализации, встроенного в код, существует начальная дата («стартовое время»), когда майнеры начинают сигнализировать, и крайний срок («тайм-аут»), после которого они сдаются, если «порог» не был достигнут. Подсчет ведется в раундах по 2016 блоков, то есть примерно двухнедельными периодами. Если в любом раунде, заканчивающемся до тайм-аута, достигается порог, то активируются новые правила. Это легко проверить каждому узлу в сети.

 ![Механизм BIP 9](taproot/bip9.svg){ width=80% }

Значение 2016 взято в силу того, что это количество блоков в одном периоде корректировки сложности, т.н. периоде перенацеливания.^[<https://en.bitcoin.it/wiki/Difficulty>] На рисунке выше каждая стрелка представляет один период сигнализирования. Циклические стрелки указывают, что состояние остается прежним — например, когда софт-форк `РАСПОЗНАН` (это означает, что узел знает о нем, но еще не сигнализирует о поддержке), он останется таким, если MTP^[MTP означает Median Time Past (медианное прошлое), и оно берется из среднего блока цепи из последних 11 блоков. Этот механизм используется для того, чтобы дестимулировать майнеров от жульничества с метками времени в сооздаваемых ими блоках.] все еще меньше `стартового времени`. Начиная со `стартового времени` состояние переходит в `ЗАПУЩЕНО`. Состояние сохраняется таким, обозначая сигнализирование о поддержке. Для каждого периода — скажем, каждые две недели — мы проверяем, достаточно ли блоков подают сигнал. Если достаточно, мы переходим к следующему этапу, который называется `ЗАФИКСИРОВАНО`. Если недостаточно, и если достигнут тайм-аут, мы переходим к состоянию `ОТВЕРГНУТО`. `ЗАФИКСИРОВАНО` — это промежуточный период, когда новые правила еще не применяются, но через две недели софт-форк становится `АКТИВНЫМ` и его правила начинают применяться.

Механизм сигнализирования передает контроль за активацией обновления в руки майнеров в течение заранее определенного периода. Для успешной активации софт-форка требуется сигнальная готовность на уровне 95 процентов.

Дополнительным преимуществом этого механизма является возможность параллельного развертывания нескольких софтфорков. Каждому назначается определенный сигнальный бит.

BIP 9 успешно использовался для развертывания софтфорков CSV и SegWit, и его можно было бы использовать и для Taproot. Первое развертывание прошло гладко, но, как мы вскоре увидим, второе вызвало много скандалов и заняло гораздо больше времени, чем многие считали нужным. Это привело к опасениям, что, возможно, BIP 9 это не самый надежный механизм развертывания. ^[Использование временных меток вместо высоты блока также выглядело излишним усложнением ситуации.] В результате было предложено несколько других механизмов, а также их вариации.

### Всегда проверяйте блоки!

К сожалению, любое сигнализирование бесполезно, если на самом деле майнеры не применяют новые правила. Помните, что для того, чтобы обеспечить соблюдение новых правил для защиты необновленных узлов, нам нужно большинство майнеров, то есть самая длинная цепочка (что, в свою очередь, позволяет этим обновлениям оставаться необязательными).

Во время софт-форка BIP 66 в 2015 году выяснилось, что большая часть майнеров, несмотря на сигнализирование о готовности, не проверяла по новым правилам.^[<https://www.reddit.com/r/Buttcoin/comments/ 6dvkr6/short_writeup_of_the_bip66_disaster_is_this/>] Как только транзакция, нарушающая новые правила, появлялась в блоке, эти майнеры не отклоняли ее, а вместо этого продолжали наращивать цепь поверх.^[<https://bitcoin.org/en/alert/ 2015-07-04-spv-mining#cause>] В то же время майнеры, которые обновились и проверяли по новым правилам, отклонили блок. Они создали альтернативный, действительный блок на той же высоте и продолжили строительство поверх этой новой ветки. В конце концов, их новая ветвь обогнала недействительную ветвь, в результате чего майнеры, не сделавшие проверку, переключились на действительную ветвь. В первый раз разветвление составило шесть блоков. На следующий день это произошло снова, но только для трех блоков, возможно, потому что  больше майнеров обновили свое программное обеспечение, узнав о проблеме.

Пропуск проверки блоков - это рискованное занятие для майнеров даже без софт-форка ^ [Еще более безрассудно для майнеров даже не проверять те _транзакции_, которые они выбрали для размещения в своих собственных блоках. Но еще в 2015 году был по крайней мере один мелкий майнер, который так и поступал: <https://www.reddit.com/r/Bitcoin/comments/3c305f/comment/csrt3dg/>], но при нормальных обстоятельствах общего согласия они могут избежать последствий. Однако при софтфорке, когда большинство майнеров применяет новые правила, а меньшинство — нет, когда один из таких майнеров случайно добывает недействительный блок, другие майнеры, не проводившие проверку, будут строить поверх него. Большинство проапгрейдившихся будет игнорировать все эти блоки, и как только их цепочка станет длиннее, все эти находящиеся в меньшинстве майнеры обнаружат, что их блоки устарели. Именно это произошло с BIP 66.

### Первая драма, а также BIP 148/91

Когда код SegWit был готов, и пришло время его внедрения, вновь был использован механизм активации BIP 9, потому что раньше он хорошо себя показал. Но по прошествии месяцев ни в один из двухнедельных периодов ретаргетинга не был достигнут требуемый 95-процентный порог сигнализирования. Хотя по блокчейну этого не скажешь, оказалось, что несколько крупных майнеров использовали сигнал готовности BIP 9 или его отсутствие в качестве голосования, что, в свою очередь, блокировало обновление.

Они не выдвигали никаких технических возражений, поэтому ранее установленный грубый консенсус в стиле RFC 7282 остался нетронутым. Была ли это просто инерция и апатия? Было ли у них тайное техническое возражение против этого предложения? ^ [Предполагалось, что метод, называемый скрытым AsicBoost, давал некоторым майнерам преимущество перед их конкурентами, которое они предпочитали не раскрывать: <https://blog.bitmex.com/ the-blocksize-war-chapter-14-asicboost/>] Или майнеры были разочарованы разработчиками и не доверяли им, возможно, отчасти из-за языковых и культурных барьеров?^[Многие майнеры были китайцами, а многие разработчики были из западных стран .]

В любом случае, BIP 9 не должен был быть референдумом, и, учитывая, как быстро майнеры смогли обновиться во время предыдущих софтфорков, этот тупик не имел большого смысла и разочаровал тех, кто хотел воспользоваться преимуществами функций SegWit, которые мы обсуждали в главе @сек:segwit. Один особенно разочаровывающий аспект этой ситуации заключается в том, что отсутствие сигнализирования сдерживало столь востребованное увеличение размера блока, которое предлагал SegWit.

В этот момент большинство разработчиков Bitcoin Core, возможно, были так же разочарованы, но предпочли остаться на консервативной стороне и просто дождаться «тайм-аута» и хоть каких-нибудь успехов. Когда нет единого мнения о новом образе действий, по умолчанию просто ничего не делают. Но это не должно останавливать никого другого.

Примерно в начале марта 2017 года группа людей сказала: «Эй, знаете что? Пришло время поменять механизм на День Д». Они выбрали 1 августа 2017 года в качестве даты и сказали, что с этого дня их узлы будут применять новые правила SegWit.

Если еще точнее, они потребовали, чтобы в этот день все блоки сигнализировали о SegWit. Эта сигнализация, в свою очередь, должна была привести к активации SegWit. Это был механизм BIP 148, и его обычно называли софт-форком, активируемым пользователем (UASF).^[<https://en.bitcoin.it/wiki/BIP_0148>] Сходство этой аббревиатуры с соответствующим родом войск вооруженных сил США помогло в его маркетинге.

Вопрос: сработало ли это? Просто взглянув на блокчейн, этого не установишь. Если посмотреть на историю блоков, видно только то, что 95 процентов сигнализировали, и софт-форк был активирован. Это, конечно, очень примечательно, что активация произошла прямо перед 1 августа, а не в какую-то другую случайную дату, когда это еще могло произойти. Но нет никаких устаревших ветвей с несигналящими блоками, на которые мы могли бы указать как на свидетельство борьбы между майнерами и узлами UASF.

Как мы объясним ниже в разделе «LOT=true», вероятно, это здорово, что не произошло конфронтации в виде конкурирующих ветвей блокчейна.

Через несколько дней после публикации BIP 148 в списке рассылки разработчиков была опубликована его альтернатива. Предлагалось активировать SegWit вместе с дополнительным удвоением размера блока с помощью хардфорка. Мы уже указывали выше, что до сих пор предложения хардфорка не выдерживали технических возражений, выдвинутых против них, например, касающихся необходимости одновременного обновления всех пользователей узлов и программного обеспечения кошельков, а также обязательного характера такого обновления.

Но, несмотря на неблагоприятный прием на техническом форуме, группа крупных биткоин-компаний встретилась в нью-йоркском отеле и объявила о так называемом Нью-Йоркском соглашении.^[<https://dcgco.medium.com/bitcoin-scaling-agreement-at-consensus-2017-133521fe9a77>] Они также добавили более низкий порог сигнала активации.

Более подробно о том, к чему это все привело, рассказывается в книге _Война за размер блока_, упомянутой в конце главы @sec:segwit. (Спойлер: они отменили хардфорк в последнюю минуту.) Для целей нашей главы интересно кратко объяснить идею снижения порога активации, которая была воспринята более положительно.

На следующий день в списке рассылки был предложен BIP 91.^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-May/014380.html>]. Он должен был работать следующим образом: если 80 процентов майнеров проголосовали "за", то (две недели спустя) все майнеры должны подать сигнал. И как только все майнеры подадут сигнал, будет достигнут 95-процентный порог. Это приведет к активации SegWit для всех вовлеченных лиц.

Пользователи, использующие более консервативный узел Bitcoin Core, увидят 95-процентный сигнал и посчитают SegWit активным. Пользователи, использующие более агрессивный узел UASF, увидят то же самое, если это произойдет до 1 августа.

Как и в случае с UASF, просто взглянув на блоки, мы не можем точно сказать, что произошло. ^[сигнал о SegWit находился в бите 1, а подписанты Нью-Йоркского соглашения сигнализировали в бите 4 (согласно BIP 91). Сигнал в четвертом бите действительно превысил требуемый порог: <https://bitcoinmagazine.com/technical/bip-91-has-activated-heres-what-means-and-what-it-does-not>. Однако это не доказывает, что BIP 91 _вызвал_ активацию SegWit. Дело в том, что все произошло слишком быстро. В период ретаргетинга статус BIP 91 был `ЗАФИКСИРОВАНО`, и это означало, что он еще не применял свое требование 100-процентной сигнализации. Но именно в этот период SegWit достиг 95-процентного порога в бите 1. Таким образом, в следующем периоде BIP 91 был `АКТИВНЫМ`, а SegWit — `ЗАФИКСИРОВАН`. В этот момент оба они требовали 100-процентной сигнализации. На самом деле вполне вероятно, что майнеры просто устанавливали сигнал в бите 4, но на самом деле не запускали какое-либо программное обеспечение, которое его использовало.]

Так что, в конце концов, все, что мы можем сказать, это то, что все прошло до странности гладко. Никто не заявлял, что другая сторона блефует. Но главным итогом произошедшего оказалось то, что все поняли: важно переосмыслить, как на самом деле следует активировать софт-форки. Ситуация, когда майнеры блокируют активацию без уважительной технической причины (публичного обмена информацией), не идеальна. Множество спорных цепочек, разделяющихся по мере того, как разные лагеря сражаются друг с другом, тоже нехорошо — это противоречит цели тщательной разработки софт-форков, поддерживающих хорошо функционирующий блокчейн.

### Переосмысление процедуры активации и внедрение BIP 8

Под впечатлением от UASF, а также ввиду очевидной необходимости отладки работы BIP 9, был предложен BIP 8^[<https://en.bitcoin.it/wiki/BIP_0008>]. ^[Если вам интересно, почему новое предложение получает меньший номер BIP, у меня есть такое предположение. Номера BIP, как правило, тематически сгруппированы в диапазоны по 10, например, BIP 340–343 все относятся к Taproot. BIP 1 и 2 — это метавопросы, и они объясняют, среди прочего, как следует обновлять Биткоин. Поэтому имеет смысл включать логику активации софт-форка в диапазон одноразрядных чисел, но заполнять его в порядке убывания.] Он использует механизм сигнализации, аналогичный BIP 9, но основанный на высоте блока, а не на метках времени. Это упрощает рассмотрение реорганизаций, например, когда последний блок сигнального периода добывается непосредственно _до_ "тайм-аута", софт-форк активируется, но затем, если бы появилась и вступила в силу альтернативная ветвь блоков, и эта альтернативная ветвь добавилась бы (то есть имела бы временные метки) непосредственно _после_ "тайм-аута" , то — на той ветке, на том переписывании истории — софтфорк бы не активировался.

Недостаток использования высоты блока состоит в томя, что вы не можете предсказать, когда произойдет «таймаут», потому что это зависит от того, насколько быстро создаются блоки. ^[Это в основном проблема для разработчиков, которые используют тестовую сеть для тестирования, скажем, программного кошелька перед реальной активацией. В тестовой сети блоки не поступают с полурегулярными 10-минутными интервалами, а вместо этого могут приходить в огромных количествах. Это делает невозможным выбор разумной высоты активации. Более подробное объяснение и решение см. в приложении @sec:more_eps к эпизоду о Signet.]

![Механизм BIP 8](taproot/bip8.svg)

До сих пор BIP 8 был просто хорошей заменой BIP 9. Но где он действительно отличается, так это в том, что он устанавливает день Д в стиле UASF, чтобы обеспечить принудительное сигнализирование. На это указывает фаза `НУЖНО_СИГНАЛИТЬ` на рисунке, который в остальном не сильно отличается от того, что вы видели выше при разборе BIP 9.

Это означает, что день Д не активирует софтфорк сам по себе. Скорее, если незадолго до дня Д появится блок, который не сигнализирует о поддержке софтфорка, этот блок будет отклонен: именно так этот механизм заставляет всех сигнализировать ближе к финалу.

Как и в случае с UASF, это принудительное сигнализирование имеет смысл только в том случае, если есть _другие_ узлы, у которых не установлено аналогичного дня Д. ^ [Для узлов без этой установки горизонтальная линия от `ЗАПУЩЕНО` до `НУЖНО СИГНАЛИТЬ` никогда не используется, и вместо этого срабатывает вертикальная линия от `ЗАПУЩЕНО` до `ОТВЕРГНУТО`, и это, по сути, BIP 9.] Вот почему сама установка дня Д не является обязательной. Что именно здесь означает не обязательно? Это может означать, что есть две разных загружаемых версии софта: одна с включенным днем Д и одна без, предположительно выпущенные двумя различными командами с разными приоритетами. Также это может означать, что есть только одна скачиваемая версия, но она позволяет пользователю выбирать.

Это позволяет использовать постепенную эскалацию: возможно, сперва большая часть сообщества не сигнализирует о дне Д, а затем, по прошествии времени, это делает все больше узлов.

В этом смысле он формализует процесс, который неофициально происходил в 2017 году, в сущности, говоря: если вы хотите сделать что-то вроде UASF, пожалуйста, сделайте это определенным образом.

Как и его предшественник, UASF, это предложение не лишено проблем. В следующих абзацах описывается, как должно работать принудительное сигнализирование.

_Если вы запустите узел, у которого включена эта функция_, то, когда после дня Д будет создан не сигнализирующий блок, ваш узел будет считать этот блок недействительным, независимо от того, сколько других блоков построено поверх него. Если некоторые майнеры создают альтернативную ветвь блоков, даже если она короче, но все блоки в ней содержат сигнал, ваш узел будет следовать этой альтернативной ветви. Таким образом, если и только если в этой альтернативной ветке будет произведено достаточно блоков, софт-форк гарантированно активируется.

С другой стороны, _если вы запускаете узел без этой функции_, или, в данном случае, если вы запускаете более старое программное обеспечение узла, которое не знает о софт-форке, тогда вы будете продолжать следовать по самой длинной цепочке, независимо от того, какие сигналы подают ее блоки. Если так случится, что самая длинная цепочка соблюдает обязательное сигнализирование, ваш узел будет следовать по ней. Если не соблюдает, ваш узел все равно будет следовать по ней. Сценарий, о котором следует беспокоиться — это когда изначально самая длинная цепочка не подает сигнал, но через некоторое время ее догоняет цепочка, которая подает сигнал. Поскольку вашему узлу все равно, сигнализируют блоки или нет, он с радостью переключится на эту новую ветку.

В любом сценарии, где существуют две альтернативные цепочки, пользователям, чей узел следует за одной ветвью, небезопасно совершать транзакции с пользователями, чей узел следует за другой ветвью. Фактически, для _всех_ небезопасно использовать блокчейн в этот момент. С другой стороны, пока единственная существующая цепочка соответствует требованию об обязательном сигнализировании, беспокоиться не о чем. Некоторым читателям это может напомнить то, что говорит теория игр о гарантированном взаимном уничтожении (MAD).

### To Argue a `LOT`

\EpisodeQR{29}

Этот параметр, требующий обязательной сигнализации, стал известен как `LOT`. Обсуждению этого мы посвятили несколько эпизодов, не все из которых вошли в настоящую книгу. Расшифровку сопровождающего эпизода можно найти здесь. ^ [Эта расшифровка была сделана Майклом Фолксоном. Сайт содержит много других расшифровок технических подкастов по Биткоину, выступлений на конференциях и даже групповых бесед. Многие из них записаны Брайаном Бишопом, также известным как Канзуре, который, возможно, печатает едва ли не быстрее всех на Земле. <https://diyhpl.us/wiki/transcripts/bitcoin-magazine/2021-02-26-taproot-activation-lockinontimeout/>]

Когда дело дошло до процесса активации Taproot, возникли споры вокруг этого параметра `LOT`, который означает фиксацию по тайм-ауту. Если обратиться к приведенной выше схеме BIP 8, там на горизонтальной стрелке есть параметр `фиксация по тайм-ауту`. Если установлено значение `false`, мы переходим в состояние `ОТВЕРГНУТО` после истечения времени ожидания софт-форка. Но когда для него установлено значение `true`, то в самый последний период перенацеливания из 2106 блоков мы переходим к состоянию `НУЖНО СИГНАЛИТЬ`, за которым всегда следует `ЗАФИКСИРОВАНО`. Другими словами, мы фиксируем состояние прямо перед тайм-аутом, отсюда и название (LOT = Lock-in On Timout).

Другими словами, и при `LOT=false`, и при `LOT=true` майнеры могут сигнализировать об обновлении в течение одного года. Затем, если указанный пороговый процент — в случае Taproot, 90 процентов — будет достигнут, происходит его активация. Однако, если он не будет достигнут, могут произойти две вещи. При `LOT=false` срок действия обновления до Taproot истечет, но если сообщество решит повторить попытку, может быть введен новый период активации для новой версии софта. С `LOT=true` узлы начнут принимать только те блоки, которые сигнализируют об обновлении, что приводит к принудительной активации.

Сперва, в начале 2021 года, еще не была выпущена версия Bitcoin Core, которая бы активировала Taproot. Команда дожидалась результатов обсуждения в сообществе, каким должен быть соответствующий механизм активации. Таким образом, это другой контекст, чем во время дебатов UASF в 2017 году, когда _существовала_ сборка Bitcoin Core BIP 9 на стадии `ЗАПУЩЕНО`. Между тем, в начале 2021 года дискуссия вращалась вокруг того, должен ли Bitcoin Core перейти от своей обычной системы развертывания BIP 9 к механизму BIP 8, и если да, то следует ли установить параметр `LOT` равным `true` или `false`.

Переход с BIP 9 на BIP 8 не вызывал особых споров, пока речь шла о его более консервативной инкарнации `LOT=false`. Но даже такое нельзя вводить бездумно, потому что при внесении _любых_ изменений всегда есть риск, особенно в отношении чего-то столь важного, как код, который решает, какие правила применяются к блокам. Таким образом, все еще сохранялся вопрос: стоит ли переходить на BIP 8 с `LOT=false`?

Возможно, стоило бы сохранить совместимость с программным обеспечением от независимой группы, которая настаивала на `LOT=true` (совместимость не должна рассматриваться как одобрение). Но этот спор так и не был решен.^ [Был запрос на добавление кода, который реализовывал переход с BIP 9 на BIP 8 в Bitcoin Core. Это общий переход, а не конкретно для Taproot. Однако он содержал `LOT=true`, что добавляло сложности и вызывало возражения. Чистая версия `LOT=false` могла бы пройти проверку. <https://github.com/bitcoin/bitcoin/pull/19573>]

Настоящая полемика развернулась вокруг `LOT=true`.

Многие люди поддержали `LOT=true`, поскольку эта опция делала так, что майнеры не могут наложить вето. Контраргументом этому является то, что майнеры все равно не имеют права вето; они могут только задержать намеченную активацию. Это связано с тем, что владельцы узлов всегда могут переключиться на новую версию ПО для нод, где предусмотрен механизм дня Д, и вовсе обойтись без сигнализирования. Но на это потребуется время. ^[Если сообщество не дождется тайм-аута и активирует софт-форк в день Д, тогда любой, кто не обновится до новой версии с днем Д, будет думать, что софт-форк не получилось активировать. Обязательное сигнализирование позволяет избежать необходимости ждать, но за это приходится платить.] Если активация задерживается из-за отсутствия сигнализирования, и при этом `LOT=false`, то по истечении года обновление будет считаться несостоявшимся. После этого можно было бы развернуть любой новый механизм обновления и, возможно, без какого-либо сигнализирования.

Another option could even be to start with `LOT=false`, wait half a year, and then say, “This is taking too long. Let’s take a little more risk and set `LOT=true`.”

The debate itself arguably ended up slowing down Taproot activation: There was no reason to believe miners would object to Taproot the way some did to SegWit, and there was no political drama around Taproot itself. It was very conceivable that a BIP 9 or BIP 8 with `LOT=false` activation would’ve gone smoothly, as it happened in the pre-SegWit era. But the debate created a stalemate, because Bitcoin Core generally doesn’t ship functionality that’s deemed controversial, and at that point, all activation options were controversial to at least some people.

It wasn’t a stalemate because some people _preferred_ `LOT=true`. Remember the RFC 7282 rough consensus process. As long as they didn’t _object_ to `LOT=false` (or BIP 9), then their preference for `LOT=true` could be dismissed. Because in that case, what would have remained were objections to `LOT=true` and no objections to `LOT=false`, and so you’d have moved forward with the thing nobody objected to.

But some people went beyond a mere preference for `LOT=true`. They claimed `LOT=false` was unsafe,^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-February/018498.html>] i.e. they objected to it. So we ended up with two proposals that both had objections. That these objections were advocated for by a very small number of developers was immaterial. They needed to be addressed, e.g. shown to be incorrect or solved somehow. And that process could and did drag on for a while.

### The Chain Split Scenario

The main objection to `LOT=true` was the same as the one raised against UASF: It could cause a chain split. Remember the reference above to MAD. An often-heard argument _for_ `LOT=true` is that a chain split is so terrible — especially for miners who wouldn’t be able to sell their new coins, it won’t happen. They believe this is sufficient deterrence for miners to simply signal. Such game theory is beyond the scope of this book, but we can clarify what such a chain split would be like and why it’s bad.

The following is one such example of how, if one part of the network runs `LOT=true` and another part runs `LOT=false` or an older version of the software, bad things could happen in the form of a chain split.

Let’s say you’re running the `LOT=true` version of Bitcoin Core and you want Taproot to activate. But the scenario here is that the rest of the world — including most miners — isn’t doing this. The day arrives and you see a block that isn’t signaling correctly but you want it to signal correctly, so you say “This block is now invalid, so I’m not going to accept this block. Instead, I’m just going to wait until another miner comes with a block that does meet my criteria.” Maybe that happens once in every 10 blocks, so you’re seeing new blocks, but they’re coming in very, very slowly.

So far, you might think this is merely annoying. But now let’s put some money on the line. What if you’re trying to receive a payment?

Let’s say somebody who runs a node with `LOT=false` sends you 1 BTC. So in this scenario, they’re on a branch that’s growing 10 times faster than the branch your node is seeing. Let’s also say their blocks aren’t completely full, so the sender uses a low fee rate. The transaction confirms quickly in their branch. But you’re on this shorter, slower-moving branch, and all those transactions have to be squeezed into fewer blocks. Those blocks are completely full. In your branch, the transaction doesn’t confirm. It’s just sitting there in the mempool.

![In this example, blocks on the fast moving side of the chain split require a fee of at least 1 satoshi per vbyte.^[<https://bitcoin.stackexchange.com/a/89418/4948>] Due to congestion on the slower moving side, its minimum fee rate is 50 sat/vbyte. A transaction paying 3 sat/vbyte only confirms on one side of the split.](taproot/split.svg)

That’s actually a relatively benevolent scenario. You’ve learned that you shouldn’t accept unconfirmed transactions. You’ll have a disagreement with your counterparty, you’ll say, “It hasn’t confirmed,” and they’ll say, “It has confirmed.” Assuming you’re aware of this chain split, you might realize what’s going on.

If you had anticipated this situation, you would’ve asked your counterparty to pay a much higher fee than their node suggests (and maybe deduct it from the amount). Otherwise, you could’ve used something called Child Pays For Parent (CPFP) by taking their unconfirmed low fee transaction and spending it back to yourself with a very high fee transaction. The combined fee is then enough for miners to include both.

A much worse scenario is when your counterparty is trying to send you coins that don’t exist on your branch. How can that be? One possibility is that they’re spending a coin that descends from a coin that was created by a miner on their branch. Every block contains a coinbase transaction, which sends the block subsidy (6.25 BTC at the time of writing), plus any transaction fees collected, to the miner. Each branch will have a different sequence of miners producing its blocks. This means each branch has unique coinbase transactions that don’t exist on the other branch. That, in turn, means any transaction spending from such a coinbase transaction can’t exist in the other branch.^[This can be used to generate something so called UTXO Fairy Dust. By deliberately spending a piece of that dust in a transaction, you can guarantee it won’t replay on the other branch.]

The general phenomenon described here is called transaction replay. In the case of a hard fork, it’s often desirable to _prevent_ transactions on one side of the fork from appearing (being replayed) on the other side. If this sounds fascinating, then you may like the author’s presentation on the topic.^[<https://sprovoost.nl/2017/11/10/a-short-history-of-replay-protection-2bd8b288cf94/>] Otherwise, just understand that whether you want to prevent replay or guarantee it, it’s a pain.

It’s possible that the coins on both branches will have a different market price. In that case, the above examples become even more complicated, because you and your counterparty can’t agree on what 1 BTC is worth.

In any case, translated to the RFC 7282 rough consensus process: If you propose something that creates the possibility of transaction replay, you should address how to deal with it.

But it gets worse.

Continuing with the above scenario of a short branch with `LOT=true` and a long branch with `LOT=false`, perhaps over time, the market price for coins on `LOT=true` increases. This price increase attracts miners, and this increase in mining activity increases the pace of block creation on this branch. In turn, it slows it down on the `LOT=false` branch.

This can lead to a tipping point if `LOT=true` overtakes the `LOT=false` branch. Your node chugs along just fine. It was following the `LOT=true` branch already when it was shorter, and it continues to do so now that it’s longer.

But your friend in the other branch is about to have a very traumatic experience. Their node detects the longer branch. From its point of view, that branch is perfectly valid; the mandatory signaling on it doesn’t violate any rules. So it’s going to switch over!

This is very bad. Any transactions your friend had sent or received on their branch, if they don’t also appear on your branch, will disappear. More accurately: Those transactions will either return to mempool, from which they could later end up getting confirmed again, or they could disappear entirely if they descend from a coinbase transaction.

Anything like a big reorganization^[<https://en.bitcoin.it/wiki/Chain_Reorganization>] will cause mayhem, even without any malicious actors. Let’s say a miner deposited coins on an exchange and your friend withdrew some coins from that same exchange. Exchanges generally don’t allocate specific coins to specific users, so there’s a chance the exchange used some of the miner coins to pay your friend. That means your friend never received that money and has to complain to the exchange. But if this happens on a large enough scale, the exchange is probably going to be insolvent.

Again translated to the RFC 7282 rough consensus process: Is it really enough to simply claim this scenario won’t happen because of incentives to prevent it? Is it so unlikely that not even a contingency plan is needed to handle it? Some cities have nuclear shelters despite the MAD game theory, though others have indeed repurposed them as shopping malls. It seems like more of a political debate than a technical discussion.

Finally, it’s worth pointing out that all the problems that `LOT=false` users are subjected to in world with `LOT=true` clients are also encountered by users who don’t upgrade at all. Avoiding mandatory upgrades is also something to consider.

### `LOT=true` Client, Rogue?

\EpisodeQR{36}

This time around, the first software download release with the Taproot activation code wasn’t Bitcoin Core. Instead, two developers decided to independently release a modified version of Bitcoin Core, which included BIP 8 and the `LOT=true` behavior.^[<https://www.reddit.com/r/Bitcoin/comments/mruopv/bitcoincorebased_bip8_lottrue_taproot_activation/>]

\noindent
With open source software, anyone is free to release any variation of the software they want. Similarly, everyone is free to download whichever variation they want. However, in addition to the general objections to `LOT=true` above, there are other practical matters to think about when downloading such an alternative implementation. We cover these in the episode above. In particular, it’s important to make sure you’re not accidentally downloading malware (see chapter @sec:guix).

### The Speedy Trial Proposal

\EpisodeQR{31}

To get out of this stalemate, Speedy Trial came to the rescue. It proposed^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-March/018583.html>] the following: “Rather than discussing whether or not there’s going to be signaling and having lots of arguments about it, let’s just try it quickly.” The proposed timeline^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-March/018594.html>] suggested the signaling would start in early May, last three months (until August), and then be activated three months later, in November.

Spoiler: As we mentioned at the beginning of the chapter, Taproot indeed activated on November 13, 2021.

![Speedy trial flow.](taproot/speedy_trial.svg)

The diagram above is quite simple to understand. Compared to BIP 9 above, it only introduces one new concept: a minimum activation height. This adds a delay in the transition from `LOCKED_IN` to `ACTIVE`.

Although it’s conceptually almost the same as BIP 9, the dates picked for Taproot are quite different than what would’ve been picked before. The waiting period before signaling (`DEFINED`), as well as the signaling period (`STARTED`), are much shorter than usual (months instead of a full year). This way, we could know the result faster.

Knowing the result quickly is great, but the rush runs the risk of miners using fake signals rather than actually upgrading. So to add a margin of safety, the transition from `LOCKED_IN` to `ACTIVE` was increased from the usual single period (two weeks) to a fixed block height, which was expected to be reached in November 2021. That was the only code change required (a much smaller change than BIP 8).

So the “speedy” part refers to figuring out miner readiness, or at least to figuring out if there was any previously unknown miner objection, or just apathy. The rest of the process was slower, and it behaved a bit more like a flag day. Once the signal threshold was reached, the soft fork was set in stone, meaning it would happen, at least if people ran the full nodes.

This process made it so Taproot would activate six months after the initial release of the software, assuming 90 percent of miners were signaling. If that threshold wasn’t met, the proposal would’ve expired, and activation options would’ve been discussed more, albeit with more data to back up decision making.

Speedy Trial seemed to sufficiently address the objections to BIP 9. From the objectors’ point of view, because it was so fast, their own plans for BIP 8 wouldn’t be delayed.

With the controversy (temporarily) out of the way, more developers came out of the woodwork and started writing code that could actually get Speedy Trial done.^[Mainly <https://github.com/bitcoin/bitcoin/pull/21377>, <https://github.com/bitcoin/bitcoin/pull/21686>, and a BIP 8-based alternative that was briefly considered: <https://github.com/bitcoin/bitcoin/pull/21392>] In turn, because there were more developers from different angles cooperating on it and getting things done a little bit more quickly, it demonstrated that Speedy Trial was a good idea. When you have some disagreement, then people start procrastinating, not reviewing things, or not writing things. But if people begin working on something quickly and it’s making progress, that’s a vague indicator that it was a good choice.

### We Have Taproot `LOCKED_IN`!

\EpisodeQR{40}

Bitcoin Core v0.21.1 with the Speedy Trial code was released on May 1, 2021.^[<https://bitcoincore.org/en/2021/05/01/release-0.21.1/>]

\noindent
The first retargeting period started a week before that release on April 24, 2021, and the threshold wasn’t reached. The second retargeting period also didn’t reach the threshold, but the third time was a charm. The 90 percent signaling threshold was reached on June 12, 2021, with `LOCKED_IN` happening a few days later.^[<https://sports.yahoo.com/locked-bitcoin-taproot-upgrade-gets-120837972.html>] It lasted until the November activation.

Remember that the signal for a soft fork (BIP 9, BIP 8, or Speedy Trial) is just a bit flag in the block header. Miners can and do use custom software to set this bit. At the same time, miners run full nodes that actually enforce the consensus rules. But if they don’t upgrade their own nodes, then their outdated nodes will simply ignore the flag, and their nodes won’t enforce the new rules. For that to happen, they need to actually upgrade their node software.

In general, it’s preferred if miners actually upgrade their nodes and don’t fake signal. That’s one reason why the timeout in BIP 9 was so long. But because Speedy Trial happened on such short notice, some may have considered it too risky to upgrade their software. Others ran into practical issues performing the upgrade. Mining pool operator Alejandro De La Torre described some of the practical issues he encountered in the field on a podcast episode.^[<https://stephanlivera.com/episode/277/>]

The accompanying episode goes into further detail about what, once Taproot activation became inevitable, needed to happen before it could ultimately be used on the Bitcoin network safely. We also explain how upcoming Bitcoin Core releases will handle the Taproot upgrade, especially with respect to its wallet software. At the time of writing, there’s some basic Taproot wallet support, but it’s still a work in progress.

### Moving Forward

Because Speedy Trial was successful, it’s possible we can use it as a template for soft fork activation moving forward. Or, we could interpret the lack of drama as an argument to just stick with BIP 9 or a `LOT=false` version of BIP 8. Perhaps some aspects of `LOT=true` deployment can be made safer.

Even if it’s inherently unsafe, it could make sense to continue developing it further, having the code already in place in case it’s ever needed. Perhaps the Bitcoin Core software could have generic support for it, even if the project itself recommends against using it. The best time to think about such matters is when they’re not yet needed.

### Burying Soft Forks

\EpisodeQR{54}

After all is said and done and a soft fork has activated, what do you do with the activation code? Is it merely a scaffold that can be removed once the new rules are active? Or is the activation mechanism itself a permanent part of the rules?

\noindent
As was done with previous soft forks, it looks like a future Bitcoin Core release will “bury” the Taproot activation. This means the node will treat the Taproot rules as if they’ve been active since Bitcoin’s very beginning. This is possible because, when applying these rules retroactively, only one historical block does not conform to them. This block can be grandfathered in.^[<https://github.com/bitcoin/bitcoin/pull/23536>]

In the episode we explain what the benefits are of burying a soft fork, in particular pointing out how it helps developers when they review the Bitcoin Core codebase or when they perform tests on it.

After that, we outline a potential edge case scenario where burying soft forks could, in a worst-case scenario, split the Bitcoin blockchain between upgraded and non-upgraded nodes. Bitcoin Core developers generally don’t consider this edge case — a very long block re-org — to be a realistic problem and/or believe that this would be such a big problem that a buried soft fork would be a minor concern comparatively. However, as we explain, not everyone agrees with this assessment entirely.
