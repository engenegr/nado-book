\newpage
## Способы активации {#sec:taproot_activation}

\EpisodeQR{3}

Софтфорк Taproot был активирован 13 ноября 2021 года, примерно через год после появления окончательной редакции кода.^[<https://github.com/bitcoin/bitcoin/pull/19953>] Это произошло куда быстрее, чем активация SegWit, и куда менее драматично, но тот год не был совсем уж лишен событий. В этой главе рассказывается, как софтфорки активировались в прошлом, какие способы активации рассматривались для Taproot и как он все-таки был активирован.

Мы посвятили этой теме пять эпизодов, и соответствующие QR-коды размещены в разных частях этой главы. Однако это далеко не однозначное сопоставление; ссылки приведены даже не в хронологическом порядке.

### Софтфорки: введение

По мере приближения развертывания Taproot вопрос о том, как активировать софт-форки, снова стал предметом дискуссий в биткоин-сообществе.

Софтфорки, если вы помните — это обратно совместимые изменения протокола. Другими словами, любой, кто обновился, будет пользоваться преимуществами, которые дает обновление, но те, кто не обновится, все равно останутся с корректно работающим софтом.

Помимо внедрения новых функций, софтфорк можно использовать для избавления от багов и потенциальных уязвимостей — по крайней мере, от некоторых из них. Это делается путем ужесточения правил, но без внезапной заморозки чьих-либо монет.

Простым примером таких более строгих правил является BIP 66,^[<https://en.bitcoin.it/wiki/BIP_0066>], который требует, чтобы любые новые подписи соответствовали строгому стандарту, в то время как ранее существовала некоторая (непреднамеренная) гибкость в способах кодирования подписей.^[<https://technicaldifficulties.io/2020/07/22/bip-66-unpacking-der-signatures/>]

Может показаться парадоксальным, что строгие правила допускают _больше_ возможностей, но в главе @sec:segwit, в разделе про будущие версии SegWit, мы объяснили, почему это так работает. В текущей главе нас меньше интересует, как работают софтфорки, и вместо этого мы сосредоточимся на том, как их активируют.

Есть несколько разных способов внедрить софтфорк. Можно сделать это случайным образом, а можно внедрить его в код намеренно. Также можно объявить дату (день Д) или высоту блока, начиная с которой применяются новые правила. Наконец — и именно так это обычно сейчас работает — можно получать сигналы от майнеров и активировать софтфорк, как только будет достигнут определенный порог.

Но то, как принимается решение о развертывании софтфорка, возможно, даже важнее, чем механика активации. А кто вообще решает?

### Самые ранние софтфорки

Хотя на заре Биткоина этого термина еще не существовало, у него было много софтфорков, в основном связанных с закрытием дыр в безопасности у раннего прототипа.^[<https://blog.bitmex.com/bitcoins-consensus-forks/>] В 2013 году произошел даже случайный софтфорк, а в 2015-м случился случайный софтфорк, который едва не пропал из-за изменений OpenSSL (см. главу @sec:libsecp).

Самые ранние софтфорки в основном использовали в качестве метода активации высоту блока  — другими словами, «начиная с вот этого будущего блока должно применяться новое правило». В идеале об этом объявляют заблаговременно, чтобы у людей было достаточно времени для обновления. В случае «секретного» софтфорка разработчики могли просто настаивать на том, чтобы люди обновлялись, а уже затем объяснять причину.

![Иллюстрация работы софтфорка, активируемого по сигналу на определенной высоте блока](taproot/flag.svg){ width=50% }

<!-- Отрегулируйте ширину вручную, чтобы примерно совпадал размер шрифта -->

Вероятно, самым печально известным софтфорком всех времен остается ограничение размера блока в один мегабайт, введенное Сатоши в 2010 году.^[Начиная с самого первого релиза версии 0.1.0 от 9 января 2009 г. существовало применяемое к самым разным вещам ограничение в 32 МБ (`MAX_SIZE`). В их число входил размер блока, который проверялся в функции `CheckBlock()`. См. <https://satoshi.nakamotoinstitute.org/code/>. Затем, 15 июля 2010 года, Сатоши ввел параметр MAX_BLOCK_SIZE=1000000 и изменил программное обеспечение для майнеров, чтобы оно не создавало блоки большего размера, чем в <https://github.com/bitcoin/bitcoin/commit/a30b56ebe76ffff9f9cc8a6667186179413c6349>. Это еще не было софтфорком. Это было просто изменение программного обеспечения, используемого майнерами, которое они могли бы отменить, что не привелоо бы к созданию недействительных блоков. Спустя несколько месяцев, 7 сентября, Сатоши модифицировал связанную функцию AcceptBlock(), чтобы принудительно внедрить MAX_BLOCK_SIZE <https://github.com/bitcoin/bitcoin/commit/f1e1fb4bdef878c8fc1564fa418d44e7541a7e83>. Это уже был настоящий софтфорк, и он был выпущен в тот же день в версии 0.3.12. Оба коммита делали вид, что отвечают за совершенно не связанные между собой вещи. В настоящее время рецензенты кода осуждают коммиты, которые касаются чего-либо за пределами области, на изменение которой они претендуют, даже если это просто удаление пустой строки.] Софтфорк был выпущен 7 сентября 2010 года, а параметр `activation_height` для него был установлен на 79 400, и этот блок был добыт всего лишь неделю спустя.^[<https://bitcointalk.org/index.php?topic=999.msg12181>].

Решение Сатоши ввести это ограничение было не только односторонним, но и тайным. Вероятно, он счел более безопасным держать это изменение в секрете, потому что не хотел предупреждать потенциальных злоумышленников о зияющей дыре в безопасности, из-за которой массивные блоки могли остановить работу сети.^[Еще в 2017 году я провел эксперимент, в котором я взял более старые версии Bitcoin Core и измерил, сколько времени им потребовалось, чтобы синхронизировать состояние блокчейна. Современные узлы делали это во много раз быстрее благодаря различным усовершенствованиям, сделанным за прошедшие годы (см., например, главу @sec:assume). Но что еще более важно, Bitcoin Core v0.5, выпущенный в 2012 году, вообще не успевал за блокчейном. При подобной попытке он бы просто упал или ушел в ступор на несколько недель. Без ограничения размера блока, введенного Сатоши, любой в 2012 году мог создать огромные блоки, которые затем перегрузили бы доступное программное обеспечение узла (см. Приложение @sec:more_eps).]

Не то чтобы никто не отслеживал изменения в исходном коде, просто на форуме, где Сатоши анонсировал этот новый релиз, в тот момент обсуждался _еще один_ софтфорк, предлагаемый для активации с блока на той же высоте. В любом случае, никто не обращал на это особого внимания до тех пор, пока много лет спустя этот уменьшенный лимит не приобрел практическую значимость в виде увеличения платы за дефицитное место в блоке.

Но если не считать каких-то экзистенциальных чрезвычайных ситуаций, существует общее мнение, что сейчас это неприемлемый способ введения софтфорка. Если бы уже тогда случились дебаты об ограничении размера блока, возможно, драму, которая разразилась позже, можно было бы предотвратить.

### Как осуществляются софтфорки?

Выпуск новой версии программного обеспечения, которая активирует софтфорк на заданной высоте — это одно. Но если его не запустят правильные люди и не сделают это вовремя, на самом деле он не возымеет эффекта. Если софтфорк выпущен в дикую природу…

Что сделал Сатоши, так это объявил о новой версии на форуме, предполагая, что сообщество достаточно маленькое, и все успеют обновиться до момента активации, даже если до него осталась всего неделя. Как правило, факт обновления не подвергался проверке, потому что многие из этих первоначальных софтфорков были сделаны таким образом, намеренно или случайно, что только злоумышленник мог создавать блоки, нарушающие новое правило, а таких вокруг было немного.

Несмотря на это, даже в 2010 году уже росло понимание того, что самый безопасный способ реализовать софтфорк — это добиться, чтобы подавляющее большинство майнеров запустило последнюю версию. Это связано с тем, что узлы будут наращивать самую длинную цепочку, которую они считают действительной. Таким образом, даже если пользователь не обновил свой узел, пока большинство майнеров соблюдают правила, они будут создавать самую длинную цепочку, и узел пользователя будет следовать за ней. Таким образом, даже если майнер злонамеренно или случайно создаст недопустимый блок, большинство майнеров не будет его надстраивать, и недействительный блок вскоре станет устаревшим. ^[См. главу @sec:eclipse для объяснения концепции устаревших блоков.]

Мы не знаем, сколько отдельных майнеров было в 2010 году, но вполне возможно, что они были в курсе этих обновлений. ^[Некоторые предполагают, что один майнер под ником Патоши, не обязательно Сатоши, контролировал более 50 процентов хэшрейта до февраля 2010 года: <https://whale-alert.medium.com/the-satoshi-fortune-e49cf73f9a9b>] При этом на майнинге нельзя было сделать деньги: первая продажа пиццы состоялась только в мае того же года.^[<https://bitcoinmagazine.com/culture/the-man-behind-bitcoin-pizza-day-is-more-than-a-meme-hes-a-mining-pioneer>] Даже в 2013г, когда произошел случайный софт-форк, достаточное количество майнеров запустило исправление всего за несколько часов.^[<https://bitcoinmagazine.com/technical/bitcoin-network-shaken-by-blockchain-fork-1363144448>] Но чрезвычайные ситуации — это не то же самое, что обычные софтфорки.

### Кто принимает решения?

Первоначально Сатоши в одностороннем порядке решал, что нужно изменить, хотя в конечном итоге он не мог заставить кого-либо запускать новые версии, которые он выпустил, поэтому он не мог вносить совершенно произвольные спорные изменения.^[Лучше покинуть вечеринку, пока еще получаешь от нее удовольствие, и, возможно, именно так он и поступил: «Но по мере того, как росло недовольство его властью и возможностями, пользователи стали слишком часто осуждать Сатоши-администратора, Сатоши-бутылочное-горлышко, Сатоши-диктатора». <https://bitcoinmagazine.com/technical/what-happened-when-bitcoin-creator-satoshi-nakamoto-disappeared>] В данный момент разработка Биткойна ведется, если не залезать в дебри, в рамках процесса «приблизительного консенсуса», как описано в RFC 7282.^[<https://datatracker.ietf.org/doc/html/rfc7282>]

Любой может предложить изменение правил Биткоина. Но нужно не только убедить других в полезности изменения; также необходимо рассмотреть все технические возражения, которые выдвигаются против него. Например, если кто-то жалуется, что предложение нарушит работу его кошелька, автор предложения не может просто сказать «не повезло». Вместо этого он должен решить проблему. Может быть, он может предложить простое исправление для рассматриваемого кошелька, или изменить свое собственное предложение, чтобы оно ничего не ломало.

Это — наряду с несколькими другими требованиями — обычно означает множество переписок по техническим спискам рассылки, а также множество итераций по улучшению предложения. Многие предложения вообще не выдерживают этот процесс, потому что оказывается, что они вызывают слишком много проблем.

Предложения о хардфорке часто отклоняются только потому, что они ломают существующее программное обеспечение и требуют одновременного обновления от всех участников. То же самое предложение, вводимое как софтфорк, решает обе проблемы, поэтому его обычно предпочитают хард-форку. Вот почему небрежное предложение разработчика Bitcoin Core Люка Даша-младшего о том, что SegWit можно реализовать как софтфорк, изменило правила игры.^[<https://news.ycombinator.com/item?id=11230394>]

Помимо отсутствия неотвеченных возражений, также необходимо привлечь достаточно опытных разработчиков для рассмотрения предложения. Таких разработчиков очень немного, и отсутствие энтузиазма у них может привести к тому, что прекрасный софтфорк никогда не увидит свет. Или, что чаще, отсутствие энтузиазма у рецензента в сочетании с трудноразрешимыми техническими проблемами будет держать предложение в подвешенном состоянии.

Но если все пойдет хорошо и код предложения в конечном итоге будет объединен с кодом Bitcoin Core, остается вопрос, какую процедуру активации применить. Это происходит в рамках такого же процесса приблизительного консенсуса, как и обсуждение самого предложения; людям может понравиться предлагаемый софтфорк, но они, по всем вышеописанным причинам, будут возражать против активации в конкретную дату. Чтобы избежать ситуаций, когда предложения застревают в ходе обсуждения их активации, в идеале сообщество соглашается на единый механизм активации, который применяется для всех софтфорков. Но, конечно, это тоже серьезная проблема для сообщества.

### Сигнализирование (BIP 9)

Итак, если день Д или некая высота блока — не лучший критерий для активации софтфорка, как сделать лучше? Одна из идей заключалась в том, чтобы майнеры сигнализировали о готовности к софтфорку в создаваемых ими блоках. Первоначально это было реализовано путем увеличения номера версии блока.^ [BIP 34 <https://en.bitcoin.it/wiki/BIP_0034> в 2012 году использовал версию 2, а BIP 66 в 2015 году использовал версию 3. Как только 95 процентов последних блоков будут содержать этот новый номер версии, должны начать применяться новые правила.] Сигнализация работает как механизм координации для сети, позволяющий выяснить, достаточно ли майнеров обновило свой софт.

Этот механизм был улучшен и формализован в BIP 9.^[<https://en.bitcoin.it/wiki/BIP_0009>] Как часть механизма сигнализации, встроенного в код, существует начальная дата («стартовое время»), когда майнеры начинают сигнализировать, и крайний срок («тайм-аут»), после которого они сдаются, если «порог» не был достигнут. Подсчет ведется в раундах по 2016 блоков, то есть примерно двухнедельными периодами. Если в любом раунде, заканчивающемся до тайм-аута, достигается порог, то активируются новые правила. Это легко проверить каждому узлу в сети.

 ![Механизм BIP 9](taproot/bip9.svg){ width=80% }

Значение 2016 взято в силу того, что это количество блоков в одном периоде корректировки сложности, т.н. периоде перенацеливания.^[<https://en.bitcoin.it/wiki/Difficulty>] На рисунке выше каждая стрелка представляет один период сигнализирования. Циклические стрелки указывают, что состояние остается прежним — например, когда софт-форк `РАСПОЗНАН` (это означает, что узел знает о нем, но еще не сигнализирует о поддержке), он останется таким, если MTP^[MTP означает Median Time Past (медианное прошлое), и оно берется из среднего блока цепи из последних 11 блоков. Этот механизм используется для того, чтобы дестимулировать майнеров от жульничества с метками времени в сооздаваемых ими блоках.] все еще меньше `стартового времени`. Начиная со `стартового времени` состояние переходит в `ЗАПУЩЕНО`. Состояние сохраняется таким, обозначая сигнализирование о поддержке. Для каждого периода — скажем, каждые две недели — мы проверяем, достаточно ли блоков подают сигнал. Если достаточно, мы переходим к следующему этапу, который называется `ЗАФИКСИРОВАНО`. Если недостаточно, и если достигнут тайм-аут, мы переходим к состоянию `ОТВЕРГНУТО`. `ЗАФИКСИРОВАНО` — это промежуточный период, когда новые правила еще не применяются, но через две недели софт-форк становится `АКТИВНЫМ` и его правила начинают применяться.

Механизм сигнализирования передает контроль за активацией обновления в руки майнеров в течение заранее определенного периода. Для успешной активации софт-форка требуется сигнальная готовность на уровне 95 процентов.

Дополнительным преимуществом этого механизма является возможность параллельного развертывания нескольких софтфорков. Каждому назначается определенный сигнальный бит.

BIP 9 успешно использовался для развертывания софтфорков CSV и SegWit, и его можно было бы использовать и для Taproot. Первое развертывание прошло гладко, но, как мы вскоре увидим, второе вызвало много скандалов и заняло гораздо больше времени, чем многие считали нужным. Это привело к опасениям, что, возможно, BIP 9 это не самый надежный механизм развертывания. ^[Использование временных меток вместо высоты блока также выглядело излишним усложнением ситуации.] В результате было предложено несколько других механизмов, а также их вариации.

### Всегда проверяйте блоки!

К сожалению, любое сигнализирование бесполезно, если на самом деле майнеры не применяют новые правила. Помните, что для того, чтобы обеспечить соблюдение новых правил для защиты необновленных узлов, нам нужно большинство майнеров, то есть самая длинная цепочка (что, в свою очередь, позволяет этим обновлениям оставаться необязательными).

Во время софт-форка BIP 66 в 2015 году выяснилось, что большая часть майнеров, несмотря на сигнализирование о готовности, не проверяла по новым правилам.^[<https://www.reddit.com/r/Buttcoin/comments/ 6dvkr6/short_writeup_of_the_bip66_disaster_is_this/>] Как только транзакция, нарушающая новые правила, появлялась в блоке, эти майнеры не отклоняли ее, а вместо этого продолжали наращивать цепь поверх.^[<https://bitcoin.org/en/alert/ 2015-07-04-spv-mining#cause>] В то же время майнеры, которые обновились и проверяли по новым правилам, отклонили блок. Они создали альтернативный, действительный блок на той же высоте и продолжили строительство поверх этой новой ветки. В конце концов, их новая ветвь обогнала недействительную ветвь, в результате чего майнеры, не сделавшие проверку, переключились на действительную ветвь. В первый раз разветвление составило шесть блоков. На следующий день это произошло снова, но только для трех блоков, возможно, потому что  больше майнеров обновили свое программное обеспечение, узнав о проблеме.

Пропуск проверки блоков - это рискованное занятие для майнеров даже без софт-форка ^ [Еще более безрассудно для майнеров даже не проверять те _транзакции_, которые они выбрали для размещения в своих собственных блоках. Но еще в 2015 году был по крайней мере один мелкий майнер, который так и поступал: <https://www.reddit.com/r/Bitcoin/comments/3c305f/comment/csrt3dg/>], но при нормальных обстоятельствах общего согласия они могут избежать последствий. Однако при софтфорке, когда большинство майнеров применяет новые правила, а меньшинство — нет, когда один из таких майнеров случайно добывает недействительный блок, другие майнеры, не проводившие проверку, будут строить поверх него. Большинство проапгрейдившихся будет игнорировать все эти блоки, и как только их цепочка станет длиннее, все эти находящиеся в меньшинстве майнеры обнаружат, что их блоки устарели. Именно это произошло с BIP 66.

### Первая драма, а также BIP 148/91

Когда код SegWit был готов, и пришло время его внедрения, вновь был использован механизм активации BIP 9, потому что раньше он хорошо себя показал. Но по прошествии месяцев ни в один из двухнедельных периодов ретаргетинга не был достигнут требуемый 95-процентный порог сигнализирования. Хотя по блокчейну этого не скажешь, оказалось, что несколько крупных майнеров использовали сигнал готовности BIP 9 или его отсутствие в качестве голосования, что, в свою очередь, блокировало обновление.

Они не выдвигали никаких технических возражений, поэтому ранее установленный грубый консенсус в стиле RFC 7282 остался нетронутым. Была ли это просто инерция и апатия? Было ли у них тайное техническое возражение против этого предложения? ^ [Предполагалось, что метод, называемый скрытым AsicBoost, давал некоторым майнерам преимущество перед их конкурентами, которое они предпочитали не раскрывать: <https://blog.bitmex.com/ the-blocksize-war-chapter-14-asicboost/>] Или майнеры были разочарованы разработчиками и не доверяли им, возможно, отчасти из-за языковых и культурных барьеров?^[Многие майнеры были китайцами, а многие разработчики были из западных стран .]

В любом случае, BIP 9 не должен был быть референдумом, и, учитывая, как быстро майнеры смогли обновиться во время предыдущих софтфорков, этот тупик не имел большого смысла и разочаровал тех, кто хотел воспользоваться преимуществами функций SegWit, которые мы обсуждали в главе @сек:segwit. Один особенно разочаровывающий аспект этой ситуации заключается в том, что отсутствие сигнализирования сдерживало столь востребованное увеличение размера блока, которое предлагал SegWit.

В этот момент большинство разработчиков Bitcoin Core, возможно, были так же разочарованы, но предпочли остаться на консервативной стороне и просто дождаться «тайм-аута» и хоть каких-нибудь успехов. Когда нет единого мнения о новом образе действий, по умолчанию просто ничего не делают. Но это не должно останавливать никого другого.

Примерно в начале марта 2017 года группа людей сказала: «Эй, знаете что? Пришло время поменять механизм на День Д». Они выбрали 1 августа 2017 года в качестве даты и сказали, что с этого дня их узлы будут применять новые правила SegWit.

Если еще точнее, они потребовали, чтобы в этот день все блоки сигнализировали о SegWit. Эта сигнализация, в свою очередь, должна была привести к активации SegWit. Это был механизм BIP 148, и его обычно называли софт-форком, активируемым пользователем (UASF).^[<https://en.bitcoin.it/wiki/BIP_0148>] Сходство этой аббревиатуры с соответствующим родом войск вооруженных сил США помогло в его маркетинге.

Вопрос: сработало ли это? Просто взглянув на блокчейн, этого не установишь. Если посмотреть на историю блоков, видно только то, что 95 процентов сигнализировали, и софт-форк был активирован. Это, конечно, очень примечательно, что активация произошла прямо перед 1 августа, а не в какую-то другую случайную дату, когда это еще могло произойти. Но нет никаких устаревших ветвей с несигналящими блоками, на которые мы могли бы указать как на свидетельство борьбы между майнерами и узлами UASF.

Как мы объясним ниже в разделе «LOT=true», вероятно, это здорово, что не произошло конфронтации в виде конкурирующих ветвей блокчейна.

Через несколько дней после публикации BIP 148 в списке рассылки разработчиков была опубликована его альтернатива. Предлагалось активировать SegWit вместе с дополнительным удвоением размера блока с помощью хардфорка. Мы уже указывали выше, что до сих пор предложения хардфорка не выдерживали технических возражений, выдвинутых против них, например, касающихся необходимости одновременного обновления всех пользователей узлов и программного обеспечения кошельков, а также обязательного характера такого обновления.

Но, несмотря на неблагоприятный прием на техническом форуме, группа крупных биткоин-компаний встретилась в нью-йоркском отеле и объявила о так называемом Нью-Йоркском соглашении.^[<https://dcgco.medium.com/bitcoin-scaling-agreement-at-consensus-2017-133521fe9a77>] Они также добавили более низкий порог сигнала активации.

Более подробно о том, к чему это все привело, рассказывается в книге _Война за размер блока_, упомянутой в конце главы @sec:segwit. (Спойлер: они отменили хардфорк в последнюю минуту.) Для целей нашей главы интересно кратко объяснить идею снижения порога активации, которая была воспринята более положительно.

На следующий день в списке рассылки был предложен BIP 91.^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-May/014380.html>]. Он должен был работать следующим образом: если 80 процентов майнеров проголосовали "за", то (две недели спустя) все майнеры должны подать сигнал. И как только все майнеры подадут сигнал, будет достигнут 95-процентный порог. Это приведет к активации SegWit для всех вовлеченных лиц.

Пользователи, использующие более консервативный узел Bitcoin Core, увидят 95-процентный сигнал и посчитают SegWit активным. Пользователи, использующие более агрессивный узел UASF, увидят то же самое, если это произойдет до 1 августа.

Как и в случае с UASF, просто взглянув на блоки, мы не можем точно сказать, что произошло. ^[сигнал о SegWit находился в бите 1, а подписанты Нью-Йоркского соглашения сигнализировали в бите 4 (согласно BIP 91). Сигнал в четвертом бите действительно превысил требуемый порог: <https://bitcoinmagazine.com/technical/bip-91-has-activated-heres-what-means-and-what-it-does-not>. Однако это не доказывает, что BIP 91 _вызвал_ активацию SegWit. Дело в том, что все произошло слишком быстро. В период ретаргетинга статус BIP 91 был `ЗАФИКСИРОВАНО`, и это означало, что он еще не применял свое требование 100-процентной сигнализации. Но именно в этот период SegWit достиг 95-процентного порога в бите 1. Таким образом, в следующем периоде BIP 91 был `АКТИВНЫМ`, а SegWit — `ЗАФИКСИРОВАН`. В этот момент оба они требовали 100-процентной сигнализации. На самом деле вполне вероятно, что майнеры просто устанавливали сигнал в бите 4, но на самом деле не запускали какое-либо программное обеспечение, которое его использовало.]

Так что, в конце концов, все, что мы можем сказать, это то, что все прошло до странности гладко. Никто не заявлял, что другая сторона блефует. Но главным итогом произошедшего оказалось то, что все поняли: важно переосмыслить, как на самом деле следует активировать софт-форки. Ситуация, когда майнеры блокируют активацию без уважительной технической причины (публичного обмена информацией), не идеальна. Множество спорных цепочек, разделяющихся по мере того, как разные лагеря сражаются друг с другом, тоже нехорошо — это противоречит цели тщательной разработки софт-форков, поддерживающих хорошо функционирующий блокчейн.

### Переосмысление процедуры активации и внедрение BIP 8

Под впечатлением от UASF, а также ввиду очевидной необходимости отладки работы BIP 9, был предложен BIP 8^[<https://en.bitcoin.it/wiki/BIP_0008>]. ^[Если вам интересно, почему новое предложение получает меньший номер BIP, у меня есть такое предположение. Номера BIP, как правило, тематически сгруппированы в диапазоны по 10, например, BIP 340–343 все относятся к Taproot. BIP 1 и 2 — это метавопросы, и они объясняют, среди прочего, как следует обновлять Биткоин. Поэтому имеет смысл включать логику активации софт-форка в диапазон одноразрядных чисел, но заполнять его в порядке убывания.] Он использует механизм сигнализации, аналогичный BIP 9, но основанный на высоте блока, а не на метках времени. Это упрощает рассмотрение реорганизаций, например, когда последний блок сигнального периода добывается непосредственно _до_ "тайм-аута", софт-форк активируется, но затем, если бы появилась и вступила в силу альтернативная ветвь блоков, и эта альтернативная ветвь добавилась бы (то есть имела бы временные метки) непосредственно _после_ "тайм-аута" , то — на той ветке, на том переписывании истории — софтфорк бы не активировался.

Недостаток использования высоты блока состоит в томя, что вы не можете предсказать, когда произойдет «таймаут», потому что это зависит от того, насколько быстро создаются блоки. ^[Это в основном проблема для разработчиков, которые используют тестовую сеть для тестирования, скажем, программного кошелька перед реальной активацией. В тестовой сети блоки не поступают с полурегулярными 10-минутными интервалами, а вместо этого могут приходить в огромных количествах. Это делает невозможным выбор разумной высоты активации. Более подробное объяснение и решение см. в приложении @sec:more_eps к эпизоду о Signet.]

![Механизм BIP 8](taproot/bip8.svg)

До сих пор BIP 8 был просто хорошей заменой BIP 9. Но где он действительно отличается, так это в том, что он устанавливает день Д в стиле UASF, чтобы обеспечить принудительное сигнализирование. На это указывает фаза `НУЖНО_СИГНАЛИТЬ` на рисунке, который в остальном не сильно отличается от того, что вы видели выше при разборе BIP 9.

Это означает, что день Д не активирует софтфорк сам по себе. Скорее, если незадолго до дня Д появится блок, который не сигнализирует о поддержке софтфорка, этот блок будет отклонен: именно так этот механизм заставляет всех сигнализировать ближе к финалу.

Как и в случае с UASF, это принудительное сигнализирование имеет смысл только в том случае, если есть _другие_ узлы, у которых не установлено аналогичного дня Д. ^ [Для узлов без этой установки горизонтальная линия от `ЗАПУЩЕНО` до `НУЖНО СИГНАЛИТЬ` никогда не используется, и вместо этого срабатывает вертикальная линия от `ЗАПУЩЕНО` до `ОТВЕРГНУТО`, и это, по сути, BIP 9.] Вот почему сама установка дня Д не является обязательной. Что именно здесь означает не обязательно? Это может означать, что есть две разных загружаемых версии софта: одна с включенным днем Д и одна без, предположительно выпущенные двумя различными командами с разными приоритетами. Также это может означать, что есть только одна скачиваемая версия, но она позволяет пользователю выбирать.

Это позволяет использовать постепенную эскалацию: возможно, сперва большая часть сообщества не сигнализирует о дне Д, а затем, по прошествии времени, это делает все больше узлов.

В этом смысле он формализует процесс, который неофициально происходил в 2017 году, в сущности, говоря: если вы хотите сделать что-то вроде UASF, пожалуйста, сделайте это определенным образом.

Как и его предшественник, UASF, это предложение не лишено проблем. В следующих абзацах описывается, как должно работать принудительное сигнализирование.

_Если вы запустите узел, у которого включена эта функция_, то, когда после дня Д будет создан не сигнализирующий блок, ваш узел будет считать этот блок недействительным, независимо от того, сколько других блоков построено поверх него. Если некоторые майнеры создают альтернативную ветвь блоков, даже если она короче, но все блоки в ней содержат сигнал, ваш узел будет следовать этой альтернативной ветви. Таким образом, если и только если в этой альтернативной ветке будет произведено достаточно блоков, софт-форк гарантированно активируется.

С другой стороны, _если вы запускаете узел без этой функции_, или, в данном случае, если вы запускаете более старое программное обеспечение узла, которое не знает о софт-форке, тогда вы будете продолжать следовать по самой длинной цепочке, независимо от того, какие сигналы подают ее блоки. Если так случится, что самая длинная цепочка соблюдает обязательное сигнализирование, ваш узел будет следовать по ней. Если не соблюдает, ваш узел все равно будет следовать по ней. Сценарий, о котором следует беспокоиться — это когда изначально самая длинная цепочка не подает сигнал, но через некоторое время ее догоняет цепочка, которая подает сигнал. Поскольку вашему узлу все равно, сигнализируют блоки или нет, он с радостью переключится на эту новую ветку.

В любом сценарии, где существуют две альтернативные цепочки, пользователям, чей узел следует за одной ветвью, небезопасно совершать транзакции с пользователями, чей узел следует за другой ветвью. Фактически, для _всех_ небезопасно использовать блокчейн в этот момент. С другой стороны, пока единственная существующая цепочка соответствует требованию об обязательном сигнализировании, беспокоиться не о чем. Некоторым читателям это может напомнить то, что говорит теория игр о гарантированном взаимном уничтожении (MAD).

### To Argue a `LOT`

\EpisodeQR{29}

Этот параметр, требующий обязательной сигнализации, стал известен как `LOT`. Обсуждению этого мы посвятили несколько эпизодов, не все из которых вошли в настоящую книгу. Расшифровку сопровождающего эпизода можно найти здесь. ^ [Эта расшифровка была сделана Майклом Фолксоном. Сайт содержит много других расшифровок технических подкастов по Биткоину, выступлений на конференциях и даже групповых бесед. Многие из них записаны Брайаном Бишопом, также известным как Канзуре, который, возможно, печатает едва ли не быстрее всех на Земле. <https://diyhpl.us/wiki/transcripts/bitcoin-magazine/2021-02-26-taproot-activation-lockinontimeout/>]

Когда дело дошло до процесса активации Taproot, возникли споры вокруг этого параметра `LOT`, который означает фиксацию по тайм-ауту. Если обратиться к приведенной выше схеме BIP 8, там на горизонтальной стрелке есть параметр `фиксация по тайм-ауту`. Если установлено значение `false`, мы переходим в состояние `ОТВЕРГНУТО` после истечения времени ожидания софт-форка. Но когда для него установлено значение `true`, то в самый последний период перенацеливания из 2106 блоков мы переходим к состоянию `НУЖНО СИГНАЛИТЬ`, за которым всегда следует `ЗАФИКСИРОВАНО`. Другими словами, мы фиксируем состояние прямо перед тайм-аутом, отсюда и название (LOT = Lock-in On Timout).

Другими словами, и при `LOT=false`, и при `LOT=true` майнеры могут сигнализировать об обновлении в течение одного года. Затем, если указанный пороговый процент — в случае Taproot, 90 процентов — будет достигнут, происходит его активация. Однако, если он не будет достигнут, могут произойти две вещи. При `LOT=false` срок действия обновления до Taproot истечет, но если сообщество решит повторить попытку, может быть введен новый период активации для новой версии софта. С `LOT=true` узлы начнут принимать только те блоки, которые сигнализируют об обновлении, что приводит к принудительной активации.

Сперва, в начале 2021 года, еще не была выпущена версия Bitcoin Core, которая бы активировала Taproot. Команда дожидалась результатов обсуждения в сообществе, каким должен быть соответствующий механизм активации. Таким образом, это другой контекст, чем во время дебатов UASF в 2017 году, когда _существовала_ сборка Bitcoin Core BIP 9 на стадии `ЗАПУЩЕНО`. Между тем, в начале 2021 года дискуссия вращалась вокруг того, должен ли Bitcoin Core перейти от своей обычной системы развертывания BIP 9 к механизму BIP 8, и если да, то следует ли установить параметр `LOT` равным `true` или `false`.

Переход с BIP 9 на BIP 8 не вызывал особых споров, пока речь шла о его более консервативной инкарнации `LOT=false`. Но даже такое нельзя вводить бездумно, потому что при внесении _любых_ изменений всегда есть риск, особенно в отношении чего-то столь важного, как код, который решает, какие правила применяются к блокам. Таким образом, все еще сохранялся вопрос: стоит ли переходить на BIP 8 с `LOT=false`?

Возможно, стоило бы сохранить совместимость с программным обеспечением от независимой группы, которая настаивала на `LOT=true` (совместимость не должна рассматриваться как одобрение). Но этот спор так и не был решен.^ [Был запрос на добавление кода, который реализовывал переход с BIP 9 на BIP 8 в Bitcoin Core. Это общий переход, а не конкретно для Taproot. Однако он содержал `LOT=true`, что добавляло сложности и вызывало возражения. Чистая версия `LOT=false` могла бы пройти проверку. <https://github.com/bitcoin/bitcoin/pull/19573>]

Настоящая полемика развернулась вокруг `LOT=true`.

Многие люди поддержали `LOT=true`, поскольку эта опция делала так, что майнеры не могут наложить вето. Контраргументом этому является то, что майнеры все равно не имеют права вето; они могут только задержать намеченную активацию. Это связано с тем, что владельцы узлов всегда могут переключиться на новую версию ПО для нод, где предусмотрен механизм дня Д, и вовсе обойтись без сигнализирования. Но на это потребуется время. ^[Если сообщество не дождется тайм-аута и активирует софт-форк в день Д, тогда любой, кто не обновится до новой версии с днем Д, будет думать, что софт-форк не получилось активировать. Обязательное сигнализирование позволяет избежать необходимости ждать, но за это приходится платить.] Если активация задерживается из-за отсутствия сигнализирования, и при этом `LOT=false`, то по истечении года обновление будет считаться несостоявшимся. После этого можно было бы развернуть любой новый механизм обновления и, возможно, без какого-либо сигнализирования.

Другим вариантом может быть даже начать с `LOT=false`, подождать полгода, а затем сказать: «Это занимает слишком много времени. Давайте добавим чуть-чуть риска и установим `LOT=true`».

Возможно, сами дебаты замедлили активацию Taproot: не было причин полагать, что майнеры будут возражать против Taproot, как некоторые ранее против SegWit, и не было политической драмы вокруг самого Taproot. Было вполне возможно, что BIP 9 или BIP 8 с активацией `LOT=false` прошли бы гладко, как это происходило в эпоху до SegWit. Но дебаты зашли в тупик, потому что Bitcoin Core, как правило, не выпускается с функциями, которые считаются спорными, а на тот момент все варианты активации были спорными, по крайней мере, для некоторых людей.

Ситуация не была патовой, потому что некоторые люди _предпочитали_ `LOT=true`. Вспомним процесс грубого консенсуса RFC 7282. Пока люди _не возражают_ против `LOT=false` (или BIP 9), их предпочтение `LOT=true` может быть проигнорировано. Потому что в этом случае остались бы только возражения против `LOT=true` и никаких возражений против `LOT=false`, и, таким образом, можно было бы внедрить то, против чего никто не возражает.

Но некоторые пошли дальше простого предпочтения `LOT=true`. Они заявили, что опция `LOT=false` небезопасна,^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-February/018498.html>], то есть против нее все же были возражения. Таким образом, имели место два предложения, и против каждого были возражения. То, что эти возражения были поддержаны очень небольшим числом разработчиков, не имело значения. Их нужно было разрешить, т.е. продемонстрировать, что они ошибочны или каким-то образом уже неактуальны. И этот процесс мог и затянулся на какое-то время.

### Сценарий разделения цепи

Основное возражение против `LOT=true` было таким же, как и против UASF: это может привести к разделению цепи. Вспомним приведенную выше ссылку на MAD. Часто звучащий аргумент _за_ `LOT=true` заключается в том, что разделение цепи — это ужасно — особенно для майнеров, которые не смогут продать свои новые монеты, а значит, этого не произойдет. Предполагается, что этого достаточно, чтобы майнеры послушно сигнализировали. Такая теория игр выходит за рамки этой книги, но мы можем пояснить, на что будет похоже подобное разделение цепочки и почему это плохо.

Ниже приведен один из примеров того, как, если в одной части сети работает `LOT=true`, а в другой части `LOT=false` или более старая версия софта, может случиться неприятность в виде разделения цепи.

Допустим, вы используете версию Bitcoin Core с `LOT=true` и хотите активировать Taproot. Но в нашем сценарии остальной мир, включая большинство майнеров, этого не делает. Наступает день, и вы видите блок, который не сигнализирует правильно, а вы хотите, чтобы он сигнализировал правильно, поэтому вы говорите: «Этот блок теперь недействителен, поэтому я не собираюсь его принимать. Вместо этого я просто подожду, пока другой майнер не предложит блок, соответствующий моим критериям». Допустим, это происходит раз в каждые десять блоков, поэтому вы видите новые блоки, но они появляются очень-очень медленно.

До сих пор можно предположить, что это раздражает, и не более. А теперь давайте положим немного денег на кон. Что если вы пытаетесь, например, получить платеж?

Допустим, кто-то, кто держит узел с `LOT=false`, отправляет вам 1 BTC. Таким образом, в этом сценарии он находится на ветке, которая растет в 10 раз быстрее, чем ветка, которую видит ваш узел. Предположим также, что блоки на ней не заполнены полностью, поэтому отправитель использует низкую комиссию. На их ветке транзакция быстро подтверждается. Но вы находитесь на своей более короткой и медленной ветке, и все эти транзакции должны быть втиснуты в меньшее количество блоков. Эти блоки полностью заполнены. В вашей ветке транзакцию не подтверждают. Она так и сидит в мемпуле.

![В этом примере блоки на быстро движущейся стороне разделения цепи требуют комиссии в размере не менее 1 sat/vbyte.^[<https://bitcoin.stackexchange.com/a/89418/4948>] Из-за переполнения на более медленно движущейся стороне минимальная ставка комиссии составляет 50 sat/vbyte. Транзакция с оплатой 3 sat/vbyte подтверждается только на одной стороне разделения.](taproot/split.svg)

На самом деле это относительно благоприятный сценарий. Вы знаете, что не следует принимать неподтвержденные транзакции. У вас возникнут разногласия с контрагентом, вы скажете: «Не подтверждено», а он скажет: «Подтверждено». Если предположить, что вы в курсе про разделение цепи, то вы можете понять, что происходит.

Если бы вы предвидели эту ситуацию, вы бы попросили своего контрагента заплатить гораздо более высокую комиссию, чем предлагает его узел (и, возможно, вычесть ее из суммы). В противном случае вы могли бы использовать штуку под названием «Ребенок платит за родителя» (CPFP), взяв неподтвержденную транзакцию контрагента с низкой комиссией и потратив ее обратно на свой же адрес с очень высокой комиссией. Таким образом, совокупной платы достаточно, чтобы майнеры включили в блок обе транзакции.

Гораздо хуже сценарий, когда ваш контрагент пытается отправить вам монеты, которых нет в вашей ветке. Как такое может произойти? Одна из возможностей заключается в том, что  тратится монета, которая происходит от монеты, созданной майнером в его ветке. Каждый блок содержит транзакцию coinbase, которая отправляет майнеру субсидию на блок (6,25 BTC на момент написания) плюс любые сборы за транзакцию. Каждая ветка будет иметь разную последовательность производящих блоки майнеров. Это означает, что в каждой ветке есть уникальные транзакции coinbase, которых нет в другой ветке. Это, в свою очередь, означает, что любые транзакционные расходы из такой транзакции coinbase не могут существовать в другой ветке. ^ [Это можно использовать для создания так называемой волшебной пыли UTXO. Намеренно тратя часть этой пыли на транзакцию, вы можете гарантировать, что она не будет воспроизводиться в другой ветке.]

То, что мы сейчас описали, называется воспроизведением транзакции. В случае хардфорка часто желательно _предотвратить_ появление (воспроизведение) транзакций c одной стороны форка на другой стороне. Если для вас эта тема звучит увлекательно, то вам может понравиться презентация автора по ней.^[<https://sprovoost.nl/2017/11/10/a-short-history-of-replay-protection-2bd8b288cf94/>] В противном случае вам достаточно просто понимать, что хотите ли вы предотвратить повтор или гарантировать его, это в любом случае означает массу проблем.

Возможно, монеты на обеих ветках будут иметь разную рыночную цену. В этом случае приведенные выше примеры становятся еще более сложными, потому что вы и ваш контрагент не сможете договориться о том, сколько стоит 1 BTC.

В любом случае, в переводе на язык процесса грубого консенсуса RFC 7282: если вы предлагаете что-то, что создает возможность воспроизведения транзакции, вы должны решить, как с этим справиться.

Но дальше все становится еще хуже.

Продолжим описанный выше сценарий с короткой веткой, имеющей параметр `LOT=true` и длинной веткой с `LOT=false`. Возможно, со временем рыночная цена монет на ветке `LOT=true` увеличится. Это повышение цен привлекает майнеров, а увеличение активности майнинга увеличивает скорость создания блоков в этой ветке. В свою очередь, это замедляет его на ветке `LOT=false`.

Это может привести к переломному моменту, когда `LOT=true` опередит ветку `LOT=false`. Ваш узел работает нормально. Он работал с веткой `LOT=true` еще тогда, когда она была короче, и продолжает делать это сейчас, когда она стала длиннее.

Но вашему другу с другой ветки предстоит пережить очень травмирующий опыт. Его узел обнаруживает более длинную ветку. С его точки зрения, эта ветка совершенно правильна; обязательная сигнализация на ней не нарушает никаких правил. И он немедленно на нее переключится!

Это очень плохо. Любые транзакции, которые ваш друг отправил или получил в своей ветке, если они не отображаются в вашей ветке, исчезнут. Точнее: эти транзакции либо вернутся в мемпул, из которого позже они могут быть снова подтверждены, либо они могут полностью исчезнуть, если они произошли от транзакции coinbase.

Любая крупная реорганизация^[<https://en.bitcoin.it/wiki/Chain_Reorganization>] вызовет хаос, даже без каких-либо злонамеренных действий. Допустим, майнер отправил монеты на биржу, а ваш друг вывел несколько монет с той же биржи. Биржи, как правило, не закрепляют определенные монеты за конкретными пользователями, поэтому есть вероятность, что биржа использовала некоторые монеты майнера для оплаты вашему другу. Это означает, что ваш друг так и не получил эти деньги и должен подать на биржу жалобу. Но если это произойдет в достаточно больших масштабах, биржа, вероятно, окажется неплатежеспособной.

Снова переведем это на язык грубого консенсуса RFC 7282: действительно ли достаточно просто заявить, что этот сценарий не произойдет из-за наличия стимулов для его предотвращения? Неужели настолько маловероятно, что нам не нужен даже план на случай непредвиденных обстоятельств? В некоторых городах есть ядерные убежища, несмотря на доктрину MAD из теории игр, хотя в других городах их действительно перепрофилировали в торговые центры. Это больше похоже на политические дебаты, чем на техническую дискуссию.


Наконец, стоит отметить, что все проблемы, с которыми сталкиваются пользователи `LOT=false` в мире, где есть клиенты с `LOT=true`, также встречаются у пользователей, которые вообще не обновляли софт. Так что стоит подумать и об отказе от обязательных обновлений.

### Клиент с`LOT=true` - не вредоносное ли это ПО?

\EpisodeQR{36}

На этот раз первым релизом софта с кодом активации Taproot был не Bitcoin Core. Вместо этого два разработчика решили выпустить независимую модифицированную версию Bitcoin Core, которая включала BIP 8 с параметром `LOT=true`.^[<https://www.reddit.com/r/Bitcoin/comments/mruopv/bitcoincorebased_bip8_lottrue_taproot_activation/>]

\noindent
В мире opensource каждый может выпускать любую версию программного обеспечения, которую захочет. Точно так же каждый может бесплатно загрузить себе любой вариант, который он хочет. Однако, в дополнение к общим возражениям против `LOT=true` выше, есть и другие практические вопросы, о которых следует подумать при загрузке такой альтернативной реализации. Мы рассказали об этом выше. В частности, важно убедиться, что вы случайно не загружаете вредоносное ПО (см. главу @sec:guix).

### Предложение пробного быстрого запуска

\EpisodeQR{31}

Чтобы выйти из этого тупика, на помощь пришло предложение о пробном быстром запуске. Было предложено^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-March/018583.html>] следующее: «Вместо того, чтобы обсуждать, сигнализировать или нет, и приводить множество аргументов на эту тему, давайте просто по-быстрому попробуем запустить новинку. Предложенный график^[<https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-March/018594.html>] предполагал, что сигнализирование начнется в начале мая, продлится три месяца (до августа), а затем через три месяца, в ноябре, произойдет активация.

Спойлер: как мы и упоминали в начале главы, Taproot действительно был активирован 13 ноября 2021 года.

![Схема пробного быстрого запуска.](taproot/speedy_trial.svg)

Эта схема довольно проста для понимания. По сравнению с BIP 9, разобранным выше, вводится только одна новая концепция: минимальная высота активации. Это добавляет задержку при переходе от `ЗАБЛОКИРОВАНО` к `АКТИВИРОВАНО`.

Хотя концептуально это почти то же самое, что и BIP 9, даты, выбранные для Taproot, сильно отличаются от тех, которые были выбраны ранее. Период ожидания перед сигнализированием (`ОПРЕДЕЛЕНО`), а также период сигнализирования (`ЗАПУЩЕНО`) намного короче, чем обычно (месяцы вместо полного года). Таким образом, мы могли бы определиться с результатом быстрее.

Быстро узнать результат — это здорово, но спешка может привести к тому, что майнеры станут использовать поддельные сигналы вместо того, чтобы обновляться. Таким образом, чтобы добавить запас прочности, переход от `ЗАБЛОКИРОВАНО` к `АКТИВИРОВАНО` был увеличен с обычного однократного периода (две недели) до фиксированной высоты блока, которой предполагалось достичь в ноябре 2021 года. Это было единственное требуемое изменение в коде (гораздо меньшее изменение, чем внедрение BIP 8).

Таким образом, «быстрая» часть относится к выяснению готовности майнеров или, по крайней мере, к выяснению того, нет ли у майнеров каких-то не высказанных ранее возражений или просто апатии. Остальная часть процесса была медленнее и больше походила на День Д. Как только порог по проценту сигнализирующих окажется достигнут, софт-форк будет высечен в камне, то есть будет предположительно состоявшимся, по крайней мере, если люди запустят полные узлы с новым ПО.

Запуск этого процесса привел бы к активирации Taproot через шесть месяцев после выпуска софта, при условии, что 90 процентов майнеров сигнализировали бы о его поддержке. Если бы этот порог не был достигнут, срок действия предложения истек бы, и варианты активации обсуждались бы дольше, хотя и с наличием на старте большего количества данных для обоснования принимаемых решений.

Пробный быстрый запуск, казалось, в достаточной степени снял возражения против BIP 9. С точки зрения возражающих, из-за того, что все было так быстро, их собственные планы относительно BIP 8 не требовалось откладывать.

Когда разногласия (временно) прекратились, многие разработчики прекратили препирательства и принялись писать код, который бы реализовывал пробный быстрый запуск.^[В основном рассматривались варианты <https://github.com/bitcoin/bitcoin/pull/21377>, <https://github.com/bitcoin/bitcoin/pull/21686>, и альтернатива, основанная на BIP 8: <https://github.com/bitcoin/bitcoin/pull/21392>] Соответственно, поскольку при написании кода сотрудничало больше разработчиков с разными подходами, и процесс двигался несколько быстрее, это продемонстрировало, что пробный быстрый запуск был хорошей идеей. Когда у вас возникают какие-то разногласия, люди начинают прокрастинировать, вместо того, чтобы писать свой код или рецензировать чужой. Но если люди начинают работать над чем-то быстро, и все продвигается вперед, это косвенный показатель того, что сам по себе выбор решения был хорош.

### И вот Taproot уже на этапе `ЗАФИКСИРОВАНО`!

\EpisodeQR{40}

Bitcoin Core v0.21.1 с кодом пробного быстрого запуска был выпущен 1 мая 2021 года.^[<https://bitcoincore.org/en/2021/05/01/release-0.21.1/>]

\noindent
Первый период ретаргетинга начался за неделю до этого релиза, 24 апреля 2021 года, и порог не был достигнут. Второй период ретаргетинга тоже не обеспечил порога, а вот третий оказался чудесен. 90-процентный порог сигнализирования был достигнут 12 июня 2021 года, а через несколько дней статус стал `ЗАФИКСИРОВАНО`.^[<https://sports.yahoo.com/locked-bitcoin-taproot-upgrade-gets-120837972.html>] Он оставался таковым до ноябрьской активации.

Вспомним, что сигнал для софт-форка (BIP 9, BIP 8 или пробный быстрый запуск) — это просто битовый флаг в заголовке блока. Для установки этого бита майнеры используют отдельный софт. В то же время майнеры запускают полные узлы, которые уже на практике обеспечивают соблюдение правил консенсуса. Но если они не обновят свои собственные узлы, то узлы, будучи устаревшими, просто проигнорируют флаг, и не будут применять новые правила. Чтобы применять их, майнерам нужно на самом деле обновить программное обеспечение своего узла.

В целом, желательно, чтобы майнеры действительно обновляли свои узлы и не подделывали сигнал. Это одна из причин, почему время ожидания в BIP 9 было таким долгим. Но из-за того, что быстрый пробный запуск прошел в такой короткий срок, некоторые могли посчитать обновление своего софта слишком рискованным. Другие столкнулись с практическими проблемами при обновлении. Оператор майнингового пула Алехандро Де Ла Торре описал некоторые практические проблемы, с которыми он столкнулся в полевых условиях, в эпизоде подкаста.^[<https://stephanlivera.com/episode/277/>]

В соответствующем разделе более подробно рассказывается о том, что должно было произойти, как только активация Taproot стала неизбежной, прежде чем его можно было бы и впрямь безопасно использовать в сети Биткоина. Мы также объясняем, как будущие версии Bitcoin Core будут работать с обновлениями Taproot, особенно в отношении кода кошелька. На момент написания статьи существует некоторая базовая поддержка кошелька Taproot, но она все еще находится в стадии разработки.

### Двигаемся дальше

Поскольку быстрый пробный запуск прошел успешно, возможно, мы сможем использовать такой способ в качестве шаблона для активации софт-форков в будущем. Или мы могли бы интерпретировать отсутствие драмы как аргумент в пользу того, чтобы просто придерживаться `BIP 9` или версии BIP 8 с `LOT = false`. Возможно, некоторые аспекты развертывания `LOT = true` можно сделать более безопасными.

Даже если такой механизм небезопасен по своей сути, может иметь смысл продолжить его разработку, имея уже готовый код на случай, если он когда-нибудь понадобится. Возможно, софт Bitcoin Core мог бы иметь его общую поддержку, даже если сам проект не рекомендует его использовать. Лучшее время для размышлений о таких вещах — это когда они еще не нужны.

### Захоронение софтфорков

\EpisodeQR{54}

После того, как все сказано и сделано, и софт-форк активирован, что делать с кодом активации? Это просто строительные леса, которые можно убрать, когда новые правила вступят в силу? Или сам механизм активации является постоянной частью правил?

\noindent
Как и в случае с предыдущими софтфорками, похоже, что будущий выпуск Bitcoin Core «похоронит» активацию Taproot. Это означает, что узел будет относиться к правилам Taproot так, как если бы они были активны с самого начала существования Биткоина. Это возможно, потому что при ретроактивном применении этих правил им не соответствует только один исторический блок. Этот блок может быть унаследован.^[<https://github.com/bitcoin/bitcoin/pull/23536>]

В этом разделе мы объясняем, в чем преимущества захоронения софтфорка, в частности, указываем, как это помогает разработчикам, когда они анализируют кодовую базу Bitcoin Core или когда проводят ее тестирование.

После этого мы обрисовываем потенциальный пограничный сценарий, когда захоронение софт-форков может, в худшем случае, разделить блокчейн Биткоина между обновленными и необновленными узлами. Разработчики Bitcoin Core, как правило, не рассматривают этот пограничный случай — очень длинную реорганизацию блока — как реальную проблему и/или считают, что это будет настолько серьезной проблемой, что скрытый софт-форк будет относительно незначительной ее частью. Однако, как мы поясняем, не все полностью согласны с этой оценкой.
